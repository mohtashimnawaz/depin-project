name: Detect secrets

on:
  pull_request:
  push:
    branches: [ main, master ]

jobs:
  detect-secrets:
    name: Detect secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: python -m pip install --upgrade pip && pip install detect-secrets

      - name: Run detect-secrets scan
        run: |
          detect-secrets scan --all-files --json > scan.json || true
          python - << 'PY'
import json, sys
s = json.load(open('scan.json'))
results = s.get('results', {})
# results is a dict of filename -> list of findings
found = any(len(v) > 0 for v in results.values())
if found:
    print('Secrets detected by detect-secrets scanner!')
    # Print a brief summary
    for f, findings in results.items():
        if findings:
            print(f"{f}: {len(findings)} potential secrets")
    sys.exit(1)
else:
    print('No secrets found')
PY
